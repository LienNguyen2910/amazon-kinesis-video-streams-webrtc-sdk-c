cmake_minimum_required(VERSION 3.6.3)

set(CMAKE_OBJECT_PATH_MAX 300)

project(libwebsocket-download NONE)

include(ExternalProject)

if (BUILD_STATIC_LIBS)
  set(LWS_WITH_STATIC 1)
  set(LWS_WITH_SHARED 0)
else()
  set(LWS_WITH_STATIC 0)
  set(LWS_WITH_SHARED 1)
endif()

if (USE_OPENSSL)
  set(LWS_WITH_MBEDTLS OFF)
else()
  set(LWS_WITH_MBEDTLS ON)
endif()

if (WIN32)
  set(LWS_HAVE_PTHREAD_H 1)
  set(EXT_PTHREAD_INCLUDE_DIR ${LWS_EXT_PTHREAD_INCLUDE_DIR})
  set(EXT_PTHREAD_LIBRARIES ${LWS_EXT_PTHREAD_LIBRARIES})
  set(OPENSSL_INCLUDE_DIRS ${LWS_OPENSSL_INCLUDE_DIRS})
  
  string(CONCAT MULTI ${MY_OPENSSL_SSL_LIBRARY} ${MY_OPENSSL_CRYPTO_LIBRARY})
  set(OPENSSL_LIBRARIES ${MULTI})
  # list(APPEND OPENSSL_LIBRARIES )
  message("OPENSSL_LIBRARIES GGGGGGGGGGGGGGGGGGG: ${OPENSSL_LIBRARIES}")

  set(WITH_THREADPOOL ${LWS_WITH_THREADPOOL})
  set(LWS_WITH_STATIC 1)
  set(LWS_WITH_SHARED 1)
endif()

message("USEOPENSSL KKKKKK: ${USE_OPENSSL}")
message("PTHREAD.h !!!!!: ${EXT_PTHREAD_INCLUDE_DIR}")
message("PTHREAD.h !!!!!**********: ${EXT_PTHREAD_LIBRARIES}")
message("OPENSSL ^^^^^^: ${OPENSSL_INCLUDE_DIRS}")
message("OPENSSL OOOOOOO: ${OPENSSL_LIBRARIES}")

ExternalProject_Add(project_libwebsockets
    GIT_REPOSITORY    https://github.com/warmcat/libwebsockets.git
    GIT_TAG           v4.2.2
    PREFIX            ${CMAKE_CURRENT_BINARY_DIR}/build
    CMAKE_ARGS
        -DCMAKE_INSTALL_PREFIX=${OPEN_SRC_INSTALL_PREFIX}
        -DCMAKE_C_FLAGS=${CMAKE_C_FLAGS}
        -DLWS_WITH_MINIMAL_EXAMPLES=1
        -DLWS_HAVE_PTHREAD_H=1 
        -DLWS_WITH_THREADPOOL=${WITH_THREADPOOL}
        -DLWS_EXT_PTHREAD_INCLUDE_DIR=${EXT_PTHREAD_INCLUDE_DIR}
        -DLWS_EXT_PTHREAD_LIBRARIES=${EXT_PTHREAD_LIBRARIES}
        -DLWS_OPENSSL_INCLUDE_DIRS=${OPENSSL_INCLUDE_DIRS}
        -DLWS_OPENSSL_LIBRARIES=${OPENSSL_LIBRARIES}
    BUILD_ALWAYS      TRUE
    TEST_COMMAND      ""
)